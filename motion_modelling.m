data = csvread('output4.txt');
datax = data(1:3:321);
t = linspace(1,11,271);
dist1 = [];

for i = 1:length(dist)
    delx = (t(i) - t(i+1))/0.5;
    calc_vel = delx*( (datax(i)/2) + (datax(i+1)/2) );
    dist1 = [dist1,calc_vel];
end

new_x = []

for i = 1:length(d)
    if (20*abs(d(i)) > 17.37)
        new_x = [new_x, 10.42 + (17.37-1).*rand(1,1)];
    elseif (20*abs(d(i)) < 10.42)
        new_x = [new_x, 10.42 + (17.37-1).*rand(1,1)];
    else
        new_x = [new_x,d(i)]
    end
end

t = linspace(1,11,271);
Y = [];

%A = 1 + 0.2219 *z^-1 - 0.1606 *z^-2 - 0.1523 *z^-3 + 0.07038 *z^-4 - 0.02172 *z^-5 + 0.09177 *z^-6 + 0.09639 *z^-7 + 0.01383 *z^-8 - 0.02164 *z^-9 + 0.06794 *z^-10 + 0.05717 *z^-11 + 0.01231 *z^-12 + 0.0152 *z^-13 + 0.04771 *z^-14 + 0.02236 *z^-15 + 0.01974 *z^-16 + 0.07135 *z^-17 + 0.04416 *z^-18 + 0.02909 *z^-19 + 0.004373 *z^-20 + 0.01498 *z^-21 - 0.001971 *z^-22 + 0.05292 *z^-23 + 0.02378 *z^-24 + 0.01574 *z^-25 + 0.02618 *z^-26 + 0.006078 *z^-27 + 0.04143 *z^-28 + 0.03357 *z^-29 + 0.009042 *z^-30 - 0.006874 *z^-31 + 0.009161 *z^-32 + 0.02561 *z^-33 + 0.01519 *z^-34 - 0.004407 *z^-35 - 0.01401 *z^-36 - 0.007918 *z^-37 - 0.0001683 *z^-38 + 0.004324 *z^-39 + 0.04488 *z^-40 + 0.0222 *z^-41 + 0.0006898 *z^-42 - 0.01631 *z^-43 + 0.003051 *z^-44 - 0.01069 *z^-45 - 0.004941 *z^-46 - 0.002877 *z^-47 + 0.002545 *z^-48 - 0.04469 *z^-49 + 0.01206 *z^-50 - 0.0144 *z^-51 + 0.01321 *z^-52 - 0.002704 *z^-53 - 0.001537 *z^-54 - 0.01583 *z^-55 + 9.469e-07 *z^-56 + 0.0004145 *z^-57 - 0.006241 *z^-58 + 0.0008753 *z^-59 + 0.01342 *z^-60;
%C = 1 - 0.5534 *z^-1 - 0.2518 *z^-2 - 0.1956 *z^-3 + 0.1122 *z^-4 - 0.1076 *z^-5 + 0.2427 *z^-6 - 0.05037 *z^-7 - 0.0869 *z^-8 - 0.07145 *z^-9 - 0.009543 *z^-10 - 0.1184 *z^-11 + 0.05596 *z^-12 + 0.0347 *z^-13 + 0.2302 *z^-14 - 0.09556 *z^-15 - 0.1187 *z^-16 + 0.1612 *z^-17 - 0.05569 *z^-18 + 0.05504 *z^-19 - 0.1038 *z^-20 + 0.09324 *z^-21 - 0.04413 *z^-22 + 0.006574 *z^-23 - 0.163 *z^-24 + 0.152 *z^-25 + 0.05994 *z^-26 - 0.09477 *z^-27 + 0.05938 *z^-28 - 0.1463 *z^-29 + 0.06535 *z^-30 + 0.239 *z^-31 + 0.07722 *z^-32 - 0.04824 *z^-33 - 0.1461 *z^-34 + 0.0002372 *z^-35 + 0.06997 *z^-36 + 0.05367 *z^-37 - 0.06397 *z^-38 - 0.0813 *z^-39 + 0.08807 *z^-40 - 0.04618 *z^-41 - 0.09729 *z^-42 - 0.04109 *z^-43 + 0.1813 *z^-44 - 0.09043 *z^-45 + 0.0879 *z^-46 - 0.198 *z^-47 - 0.1195 *z^-48 + 0.1042 *z^-49 + 0.09963 *z^-50 - 0.02399 *z^-51 - 0.0336 *z^-52 + 0.03331 *z^-53 + 0.02181 *z^-54 - 0.03609 *z^-55 + 0.09581 *z^-56 + 0.05879 *z^-57 - 0.04384 *z^-58 - 0.0486 *z^-59 + 0.03495 *z^-60;

for i = 1:length(t)
    z = t(i);
    A = 1 + 0.2219 *z^-1 - 0.1606 *z^-2 - 0.1523 *z^-3 + 0.07038 *z^-4 - 0.02172 *z^-5 + 0.09177 *z^-6 + 0.09639 *z^-7 + 0.01383 *z^-8 - 0.02164 *z^-9 + 0.06794 *z^-10 + 0.05717 *z^-11 + 0.01231 *z^-12 + 0.0152 *z^-13 + 0.04771 *z^-14 + 0.02236 *z^-15 + 0.01974 *z^-16 + 0.07135 *z^-17 + 0.04416 *z^-18 + 0.02909 *z^-19 + 0.004373 *z^-20 + 0.01498 *z^-21 - 0.001971 *z^-22 + 0.05292 *z^-23 + 0.02378 *z^-24 + 0.01574 *z^-25 + 0.02618 *z^-26 + 0.006078 *z^-27 + 0.04143 *z^-28 + 0.03357 *z^-29 + 0.009042 *z^-30 - 0.006874 *z^-31 + 0.009161 *z^-32 + 0.02561 *z^-33 + 0.01519 *z^-34 - 0.004407 *z^-35 - 0.01401 *z^-36 - 0.007918 *z^-37 - 0.0001683 *z^-38 + 0.004324 *z^-39 + 0.04488 *z^-40 + 0.0222 *z^-41 + 0.0006898 *z^-42 - 0.01631 *z^-43 + 0.003051 *z^-44 - 0.01069 *z^-45 - 0.004941 *z^-46 - 0.002877 *z^-47 + 0.002545 *z^-48 - 0.04469 *z^-49 + 0.01206 *z^-50 - 0.0144 *z^-51 + 0.01321 *z^-52 - 0.002704 *z^-53 - 0.001537 *z^-54 - 0.01583 *z^-55 + 9.469e-07 *z^-56 + 0.0004145 *z^-57 - 0.006241 *z^-58 + 0.0008753 *z^-59 + 0.01342 *z^-60;
    C = 1 - 0.5534 *z^-1 - 0.2518 *z^-2 - 0.1956 *z^-3 + 0.1122 *z^-4 - 0.1076 *z^-5 + 0.2427 *z^-6 - 0.05037 *z^-7 - 0.0869 *z^-8 - 0.07145 *z^-9 - 0.009543 *z^-10 - 0.1184 *z^-11 + 0.05596 *z^-12 + 0.0347 *z^-13 + 0.2302 *z^-14 - 0.09556 *z^-15 - 0.1187 *z^-16 + 0.1612 *z^-17 - 0.05569 *z^-18 + 0.05504 *z^-19 - 0.1038 *z^-20 + 0.09324 *z^-21 - 0.04413 *z^-22 + 0.006574 *z^-23 - 0.163 *z^-24 + 0.152 *z^-25 + 0.05994 *z^-26 - 0.09477 *z^-27 + 0.05938 *z^-28 - 0.1463 *z^-29 + 0.06535 *z^-30 + 0.239 *z^-31 + 0.07722 *z^-32 - 0.04824 *z^-33 - 0.1461 *z^-34 + 0.0002372 *z^-35 + 0.06997 *z^-36 + 0.05367 *z^-37 - 0.06397 *z^-38 - 0.0813 *z^-39 + 0.08807 *z^-40 - 0.04618 *z^-41 - 0.09729 *z^-42 - 0.04109 *z^-43 + 0.1813 *z^-44 - 0.09043 *z^-45 + 0.0879 *z^-46 - 0.198 *z^-47 - 0.1195 *z^-48 + 0.1042 *z^-49 + 0.09963 *z^-50 - 0.02399 *z^-51 - 0.0336 *z^-52 + 0.03331 *z^-53 + 0.02181 *z^-54 - 0.03609 *z^-55 + 0.09581 *z^-56 + 0.05879 *z^-57 - 0.04384 *z^-58 - 0.0486 *z^-59 + 0.03495 *z^-60;
    y = (C/(1-z^-1)*exp(t(i)))/A;
    Y = [Y,y];
end

x = 1:1:271;
coeff = [18.4881388548017 0.0117223606477231 0.00433696175976518 7.69848127649391 0.0234447212954462 1.61143826614281 5.55653714823484 0.914344130522402 -1.19831175968964 2.73246998101829 2.64925350638542 2.70513995882707 1.658994618006 2.67269822768087 2.40042422438665 2.17510591090545 2.13346963788561 0.983615051904294 1.06460410883751 2.55547462120364 -1.20323459031385 1.69140601550631 2.57891934249908 -0.53556925283114];
opf = [];
for i = 1:length(x)
    op = coeff(1)*sin(coeff(2)*x(i)+coeff(3)) + coeff(4)*sin(coeff(5)*x(i)+coeff(6)) + coeff(7)*sin(coeff(8)*x(i)+coeff(9)) + coeff(10)*sin(coeff(11)*x(i)+coeff(12)) + coeff(13)*sin(coeff(14)*x(i)+coeff(15)) + coeff(16)*sin(coeff(17)*x(i)+coeff(18)) + coeff(19)*sin(coeff(20)*x(i)+coeff(21)) + coeff(22)*sin(coeff(23)*x(i)+coeff(24));
    opf = [opf,op];
end


[xData, yData] = prepareCurveData( t, datax );

% Set up fittype and options.
ft = fittype( 'sin8' );
opts = fitoptions( 'Method', 'NonlinearLeastSquares' );
opts.Display = 'Off';
opts.Lower = [-Inf 0 -Inf -Inf 0 -Inf -Inf 0 -Inf -Inf 0 -Inf -Inf 0 -Inf -Inf 0 -Inf -Inf 0 -Inf -Inf 0 -Inf];
opts.Normalize = 'on';
opts.StartPoint = [2122.8 0.911936467233892 1.5564547214233 920.3945 1.82387293446778 -1.56888063631308 233.821607510779 3.64774586893557 1.38232415863277 168.989419754052 78.4265 1.27384391083271 153.844125318244 23.7103 0.876775478297885 158.458425792557 31.0058398859523 1.26298752072003 144.003886301183 29.1819669514845 -0.820808198859974 114.492069008823 202.449895725924 0.767566215179634];

% Fit model to data.
[fitresult, gof] = fit( xData, yData, ft, opts );

% Plot fit with data.
figure( 'Name', 'untitled fit 1' );
h = plot( fitresult, xData, yData );
legend( h, 'datax vs. t', 'untitled fit 1', 'Location', 'NorthEast' );
% Label axes
xlabel t
ylabel datax
grid on

v = [];
for i = 1:length(opfinal)
    v = [v,trapz([opfinal(i),opfinal(i+1)])];
end

d = [];
for i = 1:length(v)
    d = [d,trapz([v(i),v(i+1)])];
end

opff = old_opff;

comp_filter = (0.9*(g(1:271)'/100)) + (0.1*(opff));
opf1 = opf(1:90);
opf2 = opf(91:180);
opf2 = opf(181:271);
opff = [opf1,opf2,opf3];

plot(g(1:210)/100,'r')
hold on
plot(comp_filter(1:210),'b')
plot(opff(1:210), 'k')